---
title: "Testing global fitting algorithms"
date: 2019-04-30
output:
  html_document:
    df_print: paged
---

```{r global_stuff, include=FALSE}

knitr::opts_chunk$set(fig.width=10, 
                      fig.asp=.5, 
                      warning=FALSE)

library(Luminescence)
library(numOSL)
library(OSLdecomposition)

############# Wrapper function creating F-test tables ############# 
go_trough_n <- function(curve, algorithm = "numOSL") {
  
  results <- data.frame(NULL)
  
  for (component.number in c(1:5)) {
    
    if (algorithm == "numOSL") { ###################
      
      fit <- decomp(cbind(curve$time, curve$signal + 0.01), 
                    ncomp = component.number, 
                    constant = FALSE,
                    plot = FALSE)
      
      # was fit sucessfull?
      if (fit$message == 0) {
        result_vector <- c(fit$LMpars[,3][1:5],
                         fit$value,
                         fit$FOM)f
      } else{
      
        result_vector <- NA[1:7]
      }
      
    } else if (algorithm == "Luminescence") { ###################
    
      fit2 <- fit_OSLLifeTimes(sim_3comp)
      # fit2@data[["data"]][,1][4:6]
    }
    
    results <- rbind(results, result_vector)
  } 
  colnames(results) <- c("C1","C2","C3","C4","C5","R^2?","F?")
  return(results)
  
}

# go_trough_n(sim_3comp)
```

*Date of last significant change: 2019-04-29*

This script compares the results and robustness of two functions available for global fitting
Both functions are based on the alogrithm proposed by Blucszs & Adamiec (2006)

Compititors:
1. numOSL::decompose
2. Luminescence::fit_OSLlifetimes

Note: numOSL::decompose does not test for the best number of components. This is performed by a wrapper function



```{r prepare_data}

# Test 1: one component
tab_1comp <- data.frame(name = c("C1"),
                        lambda = c(1.5),
                        n = c(100000))
sim_1comp <- simulate_OSLcurve(tab_1comp, 
                               channel.width = 0.1,
                               channel.number = 200, 
                               simulate.curve = TRUE)
plot_OSLcurve(sim_1comp, tab_1comp)

# Test 2: Two components
tab_2comp <- data.frame(name = c("C1","C2"), 
                        lambda = c(2.5, 0.5), 
                        n = c(100000, 100000))
sim_2comp <- simulate_OSLcurve(tab_2comp, 
                               channel.width = 0.1,
                               channel.number = 200, 
                               simulate.curve = TRUE)
plot_OSLcurve(sim_2comp, tab_2comp)

# Test 3: Three components
tab_3comp <- data.frame(name = c("C1","C2","C3"), 
                        lambda = c(2.5, 0.5, 0.05), 
                        n = c(50000, 50000, 500000))
sim_3comp <- simulate_OSLcurve(tab_3comp, 
                               channel.width = 0.2,
                               channel.number = 200, 
                               simulate.curve = TRUE)
plot_OSLcurve(sim_3comp, tab_3comp)

# Test 4: Four components
tab_4comp <- data.frame(name = c("C1","C2","C3","C4"),
                        lambda = c(2,0.5,0.15,0.01), 
                        n = c(20000,20000,50000,500000))
sim_4comp <- simulate_OSLcurve(tab_4comp, 
                               channel.width = 0.2,
                               channel.number = 200, 
                               simulate.curve = TRUE)
plot_OSLcurve(sim_4comp, tab_4comp)

'
# Global mean BK8
#BK8 <- read_BIN2R(file.choose(), fastForward = TRUE)
#BK8 <- read_BIN2R("W:\\data\\BK-8_1295-1280_63-40um_2mm_Qz1_ed.BIN", 
BK8 <- read_BIN2R("C:\\Users\\mitte\\Desktop\\Masterarbeit\\data\\BK-8_1295-1280_63-40um_2mm_Qz1_ed.BIN", 
                  fastForward = TRUE,
                  txtProgressBar = FALSE)

global_BK8 <- sum_OSLcurves(BK8,
                            record_type = "OSL",
                            aliquot_selection = c(5:24),
                            output.plot = TRUE)

# First time point be at 0 sec. Therefore: move time axis one step
global_BK8$time <- global_BK8$time + global_BK8$time[2] - global_BK8$time[1]

'

```

### Analyze data with numOSL::decompose

```{r numOSL}

# insert wrapper function here #




```



### Analyze data with Luminescence::fit_OSLlifetimes

